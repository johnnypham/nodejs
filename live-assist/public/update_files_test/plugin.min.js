// plugin.js
function CR911_Plugin(){function t(){if(window.crypto&&crypto.getRandomValues&&navigator.userAgent.indexOf("Safari")==-1){var e=window.crypto.getRandomValues(new Uint32Array(3)),t="";for(var n=0,r=e.length;n<r;n++){t+=e[n].toString(36)}return t}else{return(Math.random()*(new Date).getTime()).toString(36).replace(/\./g,"")}}function n(e,t){return e.getElementsByTagName(t)[0]}function s(e,t,n){var r=u();if(!r)return;var i=n?"POST":"GET";r.open(i,e,true);if(n)r.setRequestHeader("Content-type","application/x-www-form-urlencoded");r.onreadystatechange=function(){if(r.readyState!=4)return;if(r.status!=200&&r.status!=304){return}t(r.responseText)};if(r.readyState==4)return;r.send(n)}function u(){var e=false;for(var t=0;t<o.length;t++){try{e=o[t]()}catch(n){continue}break}return e}function a(e,t){s(e,t)}function c(e){if(!M){b.emit("any-agent-available",{visitorid:y,joinas:"IMS"});return}a("chat_screen_page1.html",function(t){e.innerHTML=t;document.getElementById("CR911-radio-video-chat").onchange=document.getElementById("CR911-radio-text-chat").onchange=function(){document.getElementById("CR911-radio-video-chat").checked=false;document.getElementById("CR911-radio-text-chat").checked=false;this.checked=true};document.getElementById("lets-chat").onclick=function(){S()};document.getElementById("CR911-LA-x").onclick=function(){var t=e.firstChild||e.childNodes[0];if(n(this,"img").src.indexOf("images/close.png")!=-1){t.style.bottom="-"+(t.clientHeight-30)+"px";n(this,"img").src="images/upArrow.png"}else{t.style.bottom="0";n(this,"img").src="images/close.png"}}})}function h(e){a("chat_screen_page8.html",function(t){e.innerHTML=t;m("Trying to connect with the agent. Please wait a few seconds.");document.getElementById("CR911-send-chat-message").onclick=function(){var e=document.getElementById("CR911-input-chat-message").value;v(e);E(e);document.getElementById("CR911-input-chat-message").value=""};document.getElementById("CR911-input-chat-message").onkeyup=function(e){var t=window.event?e.which:e.keyCode;if(t==13){document.getElementById("CR911-send-chat-message").onclick()}};document.getElementById("CR911-LA-x").onclick=function(){var t=e.firstChild||e.childNodes[0];if(n(this,"img").src.indexOf("images/close.png")!=-1){t.style.bottom="-"+(t.clientHeight-30)+"px";n(this,"img").src="images/upArrow.png"}else{t.style.bottom="0";n(this,"img").src="images/close.png"}}})}function p(e){a("chat_screen_page9.html",function(t){e.innerHTML=t;m("Trying to connect with the agent. Please wait a few seconds.");document.getElementById("CR911-send-chat-message").onclick=function(){var e=document.getElementById("CR911-input-chat-message").value;v(e);E(e);document.getElementById("CR911-input-chat-message").value=""};document.getElementById("CR911-input-chat-message").onkeyup=function(e){var t=window.event?e.which:e.keyCode;if(t==13){document.getElementById("CR911-send-chat-message").onclick()}};document.getElementById("CR911-LA-x").onclick=function(){var t=e.firstChild||e.childNodes[0];if(n(this,"img").src.indexOf("images/close.png")!=-1){t.style.bottom="-"+(t.clientHeight-30)+"px";n(this,"img").src="images/upArrow.png"}else{t.style.bottom="0";n(this,"img").src="images/close.png"}}})}function d(e,t){var n=document.createElement("div");n.className="CR911-LA-online_chat_mess";n.innerHTML='<img src="images/janeline.png" alt="" />';n.innerHTML+='<div class="CR911-LA-online_chat_text">';n.innerHTML+='<h4 class="suport">'+e+'</h4><div class="CR911-LA-showing_text_whithoutBox">';n.innerHTML+="<p>"+t+"</p>";n.innerHTML+="</div></div>";document.getElementById("CR911-LA-scroll").appendChild(n)}function v(e){var t=document.createElement("div");t.className="CR911-LA-online_chat_mess_you";t.innerHTML+='<div class="CR911-LA-online_chat_text_full_width">';t.innerHTML+='<h4 class="you">You</h4><div class="CR911-LA-showing_text_whithoutBox">';t.innerHTML+="<p>"+e+"</p>";t.innerHTML+="</div></div>";document.getElementById("CR911-LA-scroll").appendChild(t)}function m(e){var t=document.createElement("div");t.className="CR911-LA-online_chat_mess_you";t.innerHTML+='<div class="CR911-LA-online_chat_text_full_width">';t.innerHTML+='<h4 class="you">System</h4><div class="CR911-LA-showing_text_whithoutBox">';t.innerHTML+="<p>"+e+"</p>";t.innerHTML+="</div></div>";if(document.getElementById("CR911-LA-scroll")){document.getElementById("CR911-LA-scroll").appendChild(t)}else document.getElementsByClassName("CR911-LA-moreinfo")[0].appendChild(t)}function w(e){if(e.requestFullscreen){e.requestFullscreen()}else if(e.mozRequestFullScreen){e.mozRequestFullScreen()}else if(e.webkitRequestFullscreen){e.webkitRequestFullscreen(Element.ALLOW_KEYBOARD_INPUT)}}function E(e){b.emit("ims",{message:e,agentid:r})}function S(){b.emit("any-agent-available",{visitorid:y,joinas:document.getElementById("CR911-radio-video-chat").checked?"IMS + Audio":"IMS"})}function L(e,t){if(!e||!t)throw"Invalid number of arguments.";if(!window.html2canvas){return load_CR911_Scripts("screenshot.js",function(){L(e,t)})}if(typeof e=="string"){e=document.querySelector(e);if(!e)e=document.getElementById(e)}if(!e)throw"HTML Element is inaccessible!";html2canvas(e,{onrendered:function(e){t(e.toDataURL())}})}function O(){if(A)return;if(!A)A=true;navigator.getMedia=navigator.webkitGetUserMedia||navigator.mozGetUserMedia;navigator.getMedia({audio:true},function(e){A=e;b.emit("plz-create-offer",{targetagent:r})},function(e){console.error(e)})}function I(e){console.error(e)}function R(){q=new M(j);if(A)q.addStream(A);q.onaddstream=function(e){var t=document.createElement("video");t.src=URL.createObjectURL(e.stream);t.style.width="100%";t.onclick=function(){w(t)};document.getElementById("CR911-LA-online_pic_thum").innerHTML="";document.getElementById("CR911-LA-online_pic_thum").appendChild(t);t.play()};q.onicecandidate=function(e){if(!e.candidate)return;b.emit("candidate",{candidate:e.candidate,targetagent:r})}}function U(){q.createAnswer(function(e){q.setLocalDescription(e);b.emit("sdp",{sdp:e,targetagent:r})},I,F)}function z(e){q.setRemoteDescription(new _(e))}var e="CR911_siteName";var r;var i=document.body||document.documentElement;var o=[function(){return new XMLHttpRequest},function(){return new ActiveXObject("Msxml2.XMLHTTP")},function(){return new ActiveXObject("Msxml3.XMLHTTP")},function(){return new ActiveXObject("Microsoft.XMLHTTP")}];var f=document.createElement("link");f.rel="stylesheet";f.type="text/css";f.href="style.css";document.documentElement.getElementsByTagName("head")[0].appendChild(f);var l=document.createElement("link");l.rel="stylesheet";l.type="text/css";l.href="images/fonts/fonts.css";document.documentElement.getElementsByTagName("head")[0].appendChild(l);a("chat_screen_page0.html",function(e){var t=document.createElement("div");t.innerHTML=e;i.appendChild(t);document.getElementsByClassName("CR911-expand-live-chat")[0].onclick=function(){c(t)}});var g="waiting";var y=t();var b=io.connect("/?userid="+y+"&status="+g+"&sitekey="+e);b.on("agent-available",function(e){r=e;var t=document.getElementById("CR911-LA-moreinfo");if(!t)t=document.getElementById("CR911-LA-live_chat_support");if(!t){if(document.getElementById("CR911-radio-video-chat")){t=document.getElementById("CR911-radio-video-chat").parentNode.parentNode.parentNode.parentNode}else throw"No such <DIV>"}if(document.getElementById("CR911-radio-video-chat")&&document.getElementById("CR911-radio-video-chat").checked){p(t)}else h(t)});b.on("no-agent-available",function(){b.emit("update-visitor-status","waiting");a("chat_screen_page3.html",function(e){var t=document.getElementById("CR911-LA-moreinfo");if(!t)t=document.getElementById("CR911-LA-live_chat_support");t.innerHTML=e;i.appendChild(t);document.getElementById("CR911-LA-x").onclick=function(){var e=t.firstChild||t.childNodes[0];if(n(this,"img").src.indexOf("images/close.png")!=-1){e.style.bottom="-"+(e.clientHeight-30)+"px";n(this,"img").src="images/upArrow.png"}else{e.style.bottom="0";n(this,"img").src="images/close.png"}}})});b.on("rejected",function(){});b.on("visitor-mediaconnection-accepted",function(e){r=e;O()});b.on("visitor-mediaconnection-rejected",function(){});b.on("join-me",function(e){r=e.agentid;document.getElementById("CR911-input-chat-message").disabled=false;document.getElementById("CR911-input-chat-message").focus();document.getElementById("CR911-send-chat-message").disabled=false;m("Agent is ready to chat with you.");if(e.joinas=="IMS + Audio"){b.emit("share-media",{agentid:e.agentid,visitorid:y})}});b.on("ims",function(e){d("Agent",e)});b.on("ims-failed",function(e){alert(e)});b.on("agent-left",function(e){if(r&&r==e){b.emit("update-visitor-status","waiting")}});var x=false;b.on("share-screen",function(){x=true;(function e(){L("body",function(t){if(k!==t){k=t;N.emit("screenshot",{agentid:r,screenshot:t})}if(x){setTimeout(e,1)}})})()});b.on("close-screen",function(){x=false});var T=false;window.addEventListener("mousemove",function(e){if(!r||!x)return;if(!T){T=true;setTimeout(function(){T=false;C.emit("coordiantes",{x:e.pageX,y:e.pageY,agentid:r})},200)}});var N=io.connect();var C=io.connect();var k="";var A;var M=window.mozRTCPeerConnection||window.webkitRTCPeerConnection;var _=window.mozRTCSessionDescription||window.RTCSessionDescription;var D=window.mozRTCIceCandidate||window.RTCIceCandidate;var P=!!navigator.webkitGetUserMedia;var H=!!navigator.mozGetUserMedia;var B=50;if(P&&navigator.userAgent.match(/Chrom(e|ium)\/([0-9]+)\./)[2]){B=parseInt(navigator.userAgent.match(/Chrom(e|ium)\/([0-9]+)\./)[2],10)}var j=[];j.push({url:"stun:stun.l.google.com:19302"});if(P&&B<28){j.push({url:"turn:homeo@turn.bistri.com:80?transport=udp",credential:"homeo"});j.push({url:"turn:homeo@turn.bistri.com:80?transport=tcp",credential:"homeo"})}if(H||P&&B<28){j.push({url:"turn:turn.bistri.com:80?transport=udp",credential:"homeo",username:"homeo"})}if(P&&B>=28){j.push({url:"turn:turn.bistri.com:80?transport=tcp",credential:"homeo",username:"homeo"})}j={iceServers:j};var F={optional:[],mandatory:{OfferToReceiveAudio:true,OfferToReceiveVideo:true}};var q;b.on("sdp",function(e){R();z(e);U()});b.on("candidate",function(e){q.addIceCandidate(new D(e))})}function load_CR911_Scripts(e,t){var n=document.createElement("script");n.src=e;if(t)n.onload=t;document.documentElement.appendChild(n)}(function(){if(!window.io){load_CR911_Scripts("socket.io.js",CR911_Plugin)}else CR911_Plugin()})()
